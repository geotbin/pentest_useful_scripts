#!/usr/bin/python2

from scapy.all import *
import sys
import argparse


IPADDR = '193.50.192.9'

# ports range
FROMPORT = 78
TOPORT = 82

# stealth disabled (-s to enable)
STEALTH = False
BANNERGRABBING = False


def isUp(ip):
    conf.verb = 0
    try:
        print("(*) Sending ping to %s" % ip)
        ping = sr1(IP(dst= ip)/ICMP(), timeout=1)
        if ping:
            print("(*) Pong received from %s" % ip)
        else:
            print("[ERROR] Host unreachable, exiting...")
            sys.exit(0)
    except Exception:
        print("[ERROR] Host unreachable, exiting...")
        sys.exit(0)


def scanPorts(ip, fromPort, toPort):
    # init variables
    # conf.verb remove scapy infos
    conf.verb = 0
    SYNACK = 0x12
    RST = 0x14
    try:
        for port in range(fromPort, toPort):

            # send SYN request to port
            syn_pkt = IP(dst=ip)/TCP(dport=port, flags='S') # 'S' for 'SYN'
            synack_pkt = sr1(syn_pkt, timeout=1)

            # no response from server (timeout)
            if synack_pkt is None:
                print("- PORT %d TIMEOUT (filtred by FIREWALL)" % port)
            # if server SEND SYNACK
            elif synack_pkt['TCP'].flags == SYNACK:
                print("[*] PORT %d OPEN" % port)
                # grabbing banner
                if BANNERGRABBING:
                    try:
                        print('   {*} TRYING TO GRAB FROM %s:%d (CTRL+C to avoid)' % (ip, port))
                        s=socket.socket()
                        s.connect((ip,port))
                        banner = s.recv(1024)
                        print (ip_address + ':' + banner)
                    except:
                        print("   [ERROR] Can't grab banner from %s:%d" % (ip, port))

                # SEND RST IN STEALTH MODE
                if STEALTH:
                    print('   {*}{*} STEALTH : SENDING RST PKT {*} TO PORT %d' % port)
                    rst_pkt = IP(dst = ip)/TCP(dport = port, flags = 'R')
                    send(rst_pkt)
            # if server send RST
            elif synack_pkt['TCP'].flags == RST:
                print("- PORT %d CLOSED (RST)" % port)
            else:
                print("- PORT %d UNKNOWN STATE" % port)
    except KeyboardInterrupt:
        sys.exit(0)






if __name__ == "__main__":

    # args for command (-h for help)
    opt = []
    parser = argparse.ArgumentParser()
    parser.add_argument("-s", "--stealth", help="enable stealth (RST pkt)",
                    action="store_true")
    parser.add_argument("-a", "--address", type=str,
                        help="target of the scan")
    parser.add_argument("-bg", "--bannergrabbing", help="enable bannergrabbing",
                    action="store_true")
    args = parser.parse_args()
    if args.address:
        IPADDR = args.address
    if args.stealth:
        STEALTH = True
        opt.append("STEALTH")
    if args.bannergrabbing:
        BANNERGRABBING = True
        opt.append("BANNER_GRABBING")

    # check if host is up
    isUp(IPADDR)
    print("[*] %s is up, scanning ports in progress.." % IPADDR)
    print("[*] Mods enabled: %s" % str(opt))
    print("====================================================")
    print("====================================================")

    scanPorts(IPADDR, FROMPORT, TOPORT)

